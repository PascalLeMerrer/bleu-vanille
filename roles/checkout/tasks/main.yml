##########  App checkout and build ##########

# - name: Delete the previous build
#   file: >
#     path="{{ tmp_directory }}" 
#     state=absent

- name: Get Git executable path
  command: which git
  register: result

- name: Get stuff from git
  local_action: >
    git repo=git@bitbucket.org:plemerrer/bleuvanille.git 
    dest="{{ tmp_directory }}" 
    update=yes
    version={{ reference }}
    force=yes
    executable="{{ result.stdout }}"

- name: Prepare the static assets (JS, CSS, images, fonts...)
  command: >
    chdir="{{ tmp_directory }}"
    gulp dist

- name: Download dependancies
  environment: { 'GO15VENDOREXPERIMENT':'1', 'GOPATH':'{{ tmp_directory }}' }
  command: >
    chdir="{{ tmp_directory }}/src/bleuvanille"
    glide install --update-vendored


- name: Build the Go application for tests
  environment: { 'GO15VENDOREXPERIMENT':1, 'GOPATH':'{{ tmp_directory }}' }
  command: >
    chdir="{{ tmp_directory }}"
    go build src/bleuvanille/server.go

- name: Create a symbolic link towards node packages directory
  file: >
    path='{{ node_modules_directory }}'
    src='{{ tmp_directory }}'
    state=link

