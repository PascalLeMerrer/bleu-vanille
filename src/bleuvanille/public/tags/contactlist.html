<contact-list>
  <div id="error-alert" show="{ failed }" class="alert">{ errorMessage }</div>

  <table class="pure-table pure-table-horizontal pure-table-striped contact-table">
    <h2>Contacts</h2>
    <thead>
      <tr>
        <th class="id-column">#</th>
        <th class="email-column">Email</th>
        <th class="date-column">Date d'inscription</th>
        <th class="action-column"></th>
      </tr>
    </thead>
    <tbody>
      <tr each={contact, index in contacts} class="pure-g">
        <td>{ index + 1 }</td>
        <td>{ contact.email }</td>
        <td>{ contact.created_at }</td>
        <td><a href="" onclick="{ parent.delete }">Supprimer</a></td>
      </tr>
    </tbody>
  </table>

  <script>
    this.failed = false
    this.selectedContact = null

    this.on('mount', function() {
      superagent.get('/admin/contacts')
        .set('Content-Type', 'application/json; charset=UTF-8')
        .end(this.loadCallback)
    });

    // processes contact list loading response
    loadCallback(err, response) {
      if (response.ok) {
        this.contacts = response.body
      } else {
        this.errorMessage = "Le chargement de la liste des contacts a échoué."
        this.failed = true
      }
      riot.update()
    }

    delete(event) {
      this.selectedContact = event.item.contact;
      superagent.del('/admin/contacts?email=' + this.selectedContact.email)
        .set('Content-Type', 'application/json; charset=UTF-8')
        .end(this.deleteCallback)
    }
    // processes contact removal response
    deleteCallback(err, response) {
      if (response.ok) {
        this.contacts.splice(this.contacts.indexOf(this.selectedContact), 1)
      } else {
        this.errorMessage = "La suppression du contact " + this.selectedContact.email + " a échoué."
        this.failed = true
      }
      riot.update()
    }
  </script>

  <style>
   .pure-g {
     letter-spacing: normal;
   }
   .contact-table {
     width:80%;
     margin-left: auto;
     margin-right: auto;
   }

   .id-column {
     width: 4em;
   }

   .email-column {
     width: 20em;
   }

   .date-column {
     width: 10em;
   }

   .action-column {
     width: 4em;
   }

  </style>
</contact-list>
