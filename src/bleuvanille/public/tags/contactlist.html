<contact-list>
  <table class="pure-table pure-table-horizontal pure-table-striped contact-table">
    <h2>Contacts</h2>
    <thead>
      <tr>
        <th class="id-column">#</th>
        <th class="email-column">Email<a href="" onclick={ sortByEmail } alt="Trier par email"> <i class="fa fa-sort"></i></a></th>
        <th class="date-column">Date d'inscription<a href="" onclick={ sortByDate } alt="Trier par date"> <i class="fa fa-sort"></i></a></th>
        <th class="useragent-column">UserAgent</th>
        <th class="referer-column">Referer</th>
        <th class="timespent-column">Temps passé (sec)</th>
        <th class="action-column">Suppression</th>
      </tr>
      </thead>
      <tbody>
      <tr each={contact, index in contacts} class="pure-g">
        <td>{ index + 1 }</td>
        <td>{ contact.email }</td>
        <td>{ contact.created_at }</td>
        <td>{ contact.userAgent }</td>
        <td>{ contact.referer }</td>
        <td>{ contact.timeSpent }</td>
        <td class="action-column"><a href="" onclick={ parent.delete } alt="Supprimer"><i class="fa fa-times"></i></a></td>
      </tr>
    </tbody>
  </table>

  <script>
    self = this
    self.selectedContact = null
    self.sorting = "newer"
    self.on('mount', function() {
      self.load()
    });

    load() {
      superagent.get('/admin/contacts?sort=' + self.sorting)
        .set('Content-Type', 'application/json; charset=UTF-8')
        .end(self.loadCallback)
    }

    sortByDate() {
      if(self.sorting == "newer") {
        self.sorting = "older"
      }
      else {
        self.sorting = "newer"
      }
      self.load()
    }

    sortByEmail() {
      self.sorting = "email"
      self.load()
    }

    // processes contact list loading response
    loadCallback(err, response) {
      if (response.ok) {
        self.contacts = response.body
        riot.update()
      } else {
        self.opts.bus.trigger('displayError', "Le chargement de la liste des contacts a échoué.")
      }
    }

    delete(event) {
      self.selectedContact = event.item.contact;
      superagent.del('/admin/contacts?email=' + self.selectedContact.email)
        .set('Content-Type', 'application/json; charset=UTF-8')
        .end(self.deleteCallback)
    }
    // processes contact removal response
    deleteCallback(err, response) {
      if (response.ok) {
        self.contacts.splice(self.contacts.indexOf(self.selectedContact), 1)
        riot.update()
      } else {
        self.opts.bus.trigger('displayError',
            "La suppression du contact " + self.selectedContact.email + " a échoué.")
      }
    }
  </script>

  <style>
   .pure-g {
     letter-spacing: normal;
   }
   .contact-table {
     width:80%;
     margin-left: auto;
     margin-right: auto;
   }

   .id-column {
     width: 2em;
   }

   .email-column {
     width: 20em;
   }

   .date-column {
     width: 10em;
   }

   .action-column {
     width: 4em;
     text-align: center;
   }

  </style>
</contact-list>
