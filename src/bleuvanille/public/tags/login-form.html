<login-form>
  <form class="w50 center" onsubmit="{ login }">
    <label for="username" class="row mts mrs mls">Adresse email</label>
    <input name="username" type="email" class="row mrs mls login">
    <label for="password" class="row mts mrs mls">Mot de passe</label>
    <input name="password" type="password" class="row mrs mls login" value="xeCuf8CHapreNe=">
    <input type="submit" value="Me connecter" class="row btn primary-btn"/>
  </form>
  <div class="w50 center pls">
    <a href="#" onclick={ sendResetLink } >J'ai oublié mon mot de passe</a>
  </div>
  <script>
  var self = this
  // Sends an authentication request to the server
  login() {
    var payload = 'email=' + self.username.value + ';password=' + self.password.value
    superagent.post('/users/login')
      .set('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8')
      .send(payload)
      .end(self.loginCallback)
  }

  // process connection request response
  loginCallback(err, response) {
    if(response.ok) {
      self.firstname = response.body.firstname
      self.lastname = response.body.lastname
      self.opts.bus.trigger('logged')
    } else {
      self.opts.bus.trigger('displayError', "Cette combinaison email / mot de passe est erronée.")
    }
    riot.update()
  }

  sendResetLink() {
    if(self.username.value != undefined && self.username.value != '')
    {
      var payload = 'email=' + self.username.value
      superagent.post('/users/sendresetlink')
        .set('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8')
        .send(payload)
        .end(self.sendResetLinkCallback)
    }
    else {
      console.log("empty email")
      self.opts.bus.trigger('displayError', "Veuillez remplir le champ email SVP.")
    }
  }

  sendResetLinkCallback(err, response) {
    if(response.ok) {
      self.opts.bus.trigger('displaySuccess', "Un email contenant un lien de réinitialisation du mot de passe vous a été adressé.")
    }
    else {
      self.opts.bus.trigger('displayError', "l'envoi du mail contenant un lien de réinitialisation du mot de passe a échoué. Votre adresse email est-elle correcte ?")
    }
  }

  </script>
</login-form>
