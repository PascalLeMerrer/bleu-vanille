<createeatable-modal>
  <div if="{ showModal }" class="overlay" onclick="{ close }"></div>
  <div if="{ showModal }" class="modal">
    <header class="header">
      <h3 class="heading">{ heading }</h3>
      <button type="button" class="close" aria-label="Fermer" onclick="{ close }">
      <span aria-hidden="true"><i class="fa fa-close fa-lg"></i></span>
      </button>
    </header>
    <div class="body container">
      <label for="eatableName">Nom</label>
      <input type="text" id="eatableName" value="{ eatable.name }"><br>
      <label for="eatableDescription">Description</label>
      <input type="text" id="eatableDescription" value="{ eatable.description }"><br>
      <fieldset>
        <legend>Nutriments pour 100 gr</legend>
        <p>
          <label for="nutrientCarbohydrate">Glucide</label>
          <input type="text" id="nutrientCarbohydrate" class="{ errorFormat: invalidCarbohydrate}" size="6" > gr <br>
          <label for="nutrientProtein">Protéine</label>
          <input type="text" id="nutrientProtein" class="{ errorFormat: invalidProtein}" size="6"> gr <br>
          <label for="nutrientSugar">Sucre</label>
          <input type="text" id="nutrientSugar" class="{ errorFormat: invalidSugar}" size="6"> gr <br>
          <label for="nutrientLipid">Lipide</label>
          <input type="text" id="nutrientLipid" class="{ errorFormat: invalidLipid}" size="6"> gr <br>
          <label for="nutrientFiber">Fibre</label>
          <input type="text" id="nutrientFiber" class="{ errorFormat: invalidFiber}" size="6"> gr <br>
          <label for="nutrientAlcohol">Alcool</label>
          <input type="text" id="nutrientAlcohol" class="{ errorFormat: invalidAlcohol}" size="6"> gr <br>
        </p>
      </fieldset>
    </div>
    <footer class="footer mod">
      <div class="fr btn-container">
        <button class="btn danger-btn" type="button" onclick="{ close }">
        Annuler
        </button>
        <button class="btn primary-btn" type="button" onclick="{ create }">
        Créer
        <i if="{ isWaiting }" class="fa fa-spinner fa-pulse fa-lg"></i>
        </button>
      </div>
      <div class="clear"></div>
    </footer>
  </div>

  <script>
    var self = this
    self.showModal = false
    self.heading = null    
    self.buttons = null


    self.invalidName = false
    self.invalidCarbohydrate = false
    self.invalidProtein = false
    self.invalidSugar = false
    self.invalidLipid = false
    self.invalidFiber = false
    self.invalidAlcohol = false



    self.opts.bus.on('openCreateEatableModal', function(params) {
        self.eatable = {
                "name" : "",
                "type" : "ingredient",
                "description" : ""
        }
            
        self.nutrient = {
                    "carbohydrate" : 0,
                    "sugar" : 0,
                    "protein" : 0,
                    "lipid" : 0,
                    "fiber" : 0,
                    "alcohol" : 0
        }

        self.showModal = true
        self.heading = params.title
        self.content = params.content
        self.buttons = params.buttons
        self.update()
    }) 

    
    self.opts.bus.on('closeCreateEatableModal', function() {
        self.close()
    })

    close() {
        self.showModal = false
        self.update()
    }
    
    create() {
        self.invalidName = (self.eatableName.value.length === 0)
        if (self.invalidName) {
          self.eatableName.title = "Vous devez spécifier un nom d'ingrédient"
        } else {
    	    self.eatable.name = self.eatableName.value;
        }
      	
      	self.eatable.description = self.eatableDescription.value;
  		
      	self.invalidCarbohydrate = self.copyNutrientInput(self.nutrientCarbohydrate, 'carbohydrate')    	 
      	self.invalidProtein      = self.copyNutrientInput(self.nutrientProtein, 'protein')    	
      	self.invalidSugar        = self.copyNutrientInput(self.nutrientSugar, 'sugar')    	
      	self.invalidLipid        = self.copyNutrientInput(self.nutrientLipid, 'lipid')    	
      	self.invalidFiber        = self.copyNutrientInput(self.nutrientFiber, 'fiber')    	
      	self.invalidAlcohol      = self.copyNutrientInput(self.nutrientAlcohol, 'alcohol') 
        self.update()

        if ( !self.invalidName
          && !self.invalidCarbohydrate
          && !self.invalidProtein
          && !self.invalidSugar
          && !self.invalidLipid
          && !self.invalidFiber
          && !self.invalidAlcohol) {
            superagent.post('/eatables')
            .set('Content-Type', 'application/json; charset=UTF-8')
            .send(self.eatable)
            .end(self.createCallback)
        }
    }
    
    createCallback(err, response) {
    	    if(response.ok) {
    	      self.eatable = response.body
	  	      self.opts.bus.trigger('setJustCreatedEatable', self.eatable)
    	      superagent.put('/eatables/' + self.eatable._key + '/nutrient')
    	        .set('Content-Type', 'application/json; charset=UTF-8')
    	        .send(self.nutrient)
    	        .end(self.createNutrientCallback)
    	    } else {
    	      self.opts.bus.trigger('displayError', "Erreur : " + response.code + " : " + response.body.error)
    	      self.update()
    	    }
    }
    
    createNutrientCallback(err, response) {
	    if(response.ok) {
  	      self.opts.bus.trigger('displaySuccess', "L'ingrédient " + self.eatable.name + " a été créé.")
  	      self.close()
 	    } else {
  	      self.opts.bus.trigger('displayError', "Erreur : " + response.code + " : " + response.body.error)
	      self.update()
	    }
 	}
    
    /**
     * Checks if a nutrient input field contains a numeric value between 1 and 100
     * If so, copies its value in the given property
     * @return false when there is no error, true when the value is incorrect
     */
    copyNutrientInput(inputField, propertyName) {
      var intValue = parseInt(inputField.value);
      if (isNaN(intValue) || intValue < 1 || intValue > 100) {
          inputField.title = "Doit être un chiffre de 1 à 100";
          return true
  		}
  	  self.nutrient[propertyName] = intValue
      return false
    }
  </script>
  <style scoped>
    .overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 100;
    }

    .overlay.dismissable {
      cursor: pointer;
    }

    .modal {
      position: absolute;
      width: 95%;
      max-width: 50.0rem;
      font-size: 1.0rem;
      top: 50%;
      left: 50%;
      transform: translate3d(-50%, -50%, 0);
      background-color: white;
      color: #252519;
      z-index: 200;
      border-radius: 0.5rem;
    }

    .header {
      position: relative;
      text-align: center;
      border-radius: 0.5rem 0.5rem 0 0;
    }

    .heading {
      padding: 1.0rem 2.0rem 1.0rem 2.0rem;
      margin: 0;
      font-size: 2rem;
    }

    .close {
      position: absolute;
      top: 0.5rem;
      right: 1.0rem;
      padding: 0;
      font-size: 1.2rem;
      border: 0;
      background-color: transparent;
      cursor: pointer;
      outline: none;
    }

    .body {
      padding: 2.0rem;
      font-size: 1.5rem;
    }

    .footer {
      padding: 0 2.0rem 2.0rem 2.0rem;
    }

    .btn-container {
      margin-left: 2rem;
    }

	.errorFormat {
		border: 1px solid #FF0000;
	}
	
	label {
	  display: inline-block;
	  width: 140px;
	  text-align: right;
	}
	
	legend {
    text-align: center
}

fieldset {
    border: 1px solid #c0c0c0;
    padding: 0.35em 0.625em 0.75em;
    text-align: center;
}​
  </style>
</createeatable-modal>
