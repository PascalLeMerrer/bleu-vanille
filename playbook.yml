- hosts: dev
  connection: local
  
  vars:
     local_git: "{{ lookup('env','GIT_EXECUTABLE') }}"
     tmp_directory: "{{ playbook_dir }}/deploy"

  tasks:

  - file: path={{ tmp_directory }} state=absent
    tags: package
    
  - name: Get stuff from git
    local_action: git repo=git@bitbucket.org:plemerrer/bleuvanille.git dest={{ tmp_directory }} update=yes executable={{ local_git }}
    tags: package

  - name: Prepare the static assets (JS, CSS, images, fonts...)
    command: chdir={{ tmp_directory }} gulp dist
    tags: package

  - name: Download dependancies
    environment: { "GO15VENDOREXPERIMENT":"1", 'GOPATH':'{{ tmp_directory }}' }
    command: chdir={{ tmp_directory }}/src/bleuvanille glide install
    tags: package

  - name: Get the sha1 of the current git commit
    command: chdir={{ tmp_directory }} git rev-parse HEAD
    register: result
    tags: [package,deploy]

  - name: Set the sha1 variable
    set_fact: sha1={{ result.stdout }}
    tags: [package,deploy]


  - name: Build the Go application with the sha1 as version number
    environment: { 'GO15VENDOREXPERIMENT':1, 'GOPATH':'{{ tmp_directory }}' }
    command: chdir={{ tmp_directory }} go build -ldflags "-X main.Sha1={{ sha1 }}" src/bleuvanille/server.go
    tags: package

  - name: set the executable mode
    file: path="{{ tmp_directory }}/server" mode="u+x"  
    tags: package
  
  - name: rename the executable
    command: mv {{ tmp_directory }}/server {{ tmp_directory }}/bleuvanille  
    tags: package
  
  - name: copy the executable to dist
    copy: src="{{ tmp_directory }}/bleuvanille" dest="{{ tmp_directory }}/dist"   
    tags: package
  
  - name: copy the HTML templates to dist
    copy: src="{{ playbook_dir }}/src/bleuvanille/templates" dest="{{ tmp_directory }}/dist/src/bleuvanille"
    tags: package

  - name: create archive
    command: chdir="{{ tmp_directory }}/dist" tar -zcf {{ tmp_directory }}/bleuvanille-{{ sha1 }}.tar.gz .
    tags: package
  
  - debug: msg="Built package for commit {{ sha1 }} in deploy directory"

- hosts: production
  
  remote_user: root
  
  vars:
     tmp_directory: "{{ playbook_dir }}/deploy"
  
  tasks:
  
  - name: Set the sha1 variable
    set_fact: sha1={{hostvars.localhost.sha1}}
    tags: deploy

  - name: Set the target directory variable
    set_fact: target_dir="/root/bleuvanille-{{ sha1 }}"
    tags: deploy

  - name: create target directory
    file: path="{{ target_dir }}" state=directory
    tags: deploy

  - name: copy the archive to server
    copy: src="{{ tmp_directory }}/bleuvanille-{{ sha1 }}.tar.gz" dest="{{ target_dir }}/bleuvanille-{{ sha1 }}.tar.gz"
    tags: deploy
  
  - unarchive: src={{ target_dir }}/bleuvanille-{{ sha1 }}.tar.gz dest={{ target_dir }} copy=no
    tags: deploy

  - name: delete archive
    file: path="{{ target_dir }}/bleuvanille-{{ sha1 }}.tar.gz" state=absent
    tags: deploy

  - name: create a symbolic link towards target directory
    file: path="/root/prod" src={{ target_dir }}  state=link
    tags: deploy

  - debug: msg="Deployed package for commit {{ sha1 }} on production server"
    tags: deploy
